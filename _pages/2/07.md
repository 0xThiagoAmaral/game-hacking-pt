---
title: Usando Code Caves
author: attilathedud
date: 2023-12-25
category: Debugging e Reversão
layout: post
---

# Alvo

Nosso alvo nesta aula é o **Wesnoth 1.14.9**.

# Identificar

Vamos criar uma code cave dentro do Wesnoth que, toda vez que o jogador clica em *Terrain Description*, **aumenta o ouro para 999** antes de exibir a caixa de descrição de terreno.

# Entender

Para criar a cave, precisamos de dois endereços:
1. **O ponto a redirecionar** — a instrução original que queremos substituir
2. **O local da cave** — uma área vazia de memória onde vamos escrever nosso código

Depois: criamos o esqueleto da cave no local 2, e inserimos o salto `jmp` no local 1 para redirecionar até lá.

# Localizando o Ouro

Como vamos modificar o ouro, precisamos primeiro encontrar seu endereço. Abra o Wesnoth, crie um jogo local, e repita o processo do [Memory Hack](/pages/1/05/) para encontrar o endereço do ouro.

> **Lembrete:** O endereço vai ser diferente a cada sessão (DMA). Nestes exemplos, usaremos `0x05F3B85C`.

# Localizando a Cave

Precisamos encontrar um espaço vazio na memória do Wesnoth para colocar nossa cave. O local mais fácil é **o final do módulo executável** — quase todo `.exe` tem uma grande área de zeros não utilizados lá.

No x64dbg, vá até o final do módulo do Wesnoth. No nosso exemplo, esse espaço vazio começa em `0x0134360E`:

![Seção de Memória Vazia no Final do Wesnoth](/assets/images/2/7/wesnoth1.png)

# Local do Hook

Agora precisamos identificar onde vamos "hookear" o código — ou seja, onde vamos inserir o salto para a cave. Usaremos o mesmo `call` do *Terrain Description* que identificamos na aula de Reversão de Código: `0xCCAF90`.

![Método de Terrain Description](/assets/images/2/7/wesnoth2.png)

# Redirecionamento

Antes de modificar qualquer código, pause o jogo no x64dbg. Isso evita que o game acidentalmente entre na cave incompleta e trave:

![Função Pause do x64dbg](/assets/images/2/7/wesnoth3.png)

Agora vamos entender os opcodes. A instrução `jmp` com endereço absoluto ocupa **5 bytes**. Precisamos encontrar 5 bytes contíguos para substituir. Olhando as instruções em `0x00CCAF8A`:

```c++
opcode      instrução
----------------------------------------
8B01        mov eax, dword ptr ds:[ecx]     ; 2 bytes
8D7426 00   lea esi, dword ptr ds:[esi]     ; 4 bytes
FF50 28     call dword ptr ds:[eax+28]      ; 3 bytes
B0 01       mov al,1                        ; 2 bytes
```

A primeira instrução tem 2 bytes e a segunda tem 4 bytes — juntas são 6 bytes (mais do que os 5 que precisamos). Vamos substituir as duas primeiras por `jmp 0x0134360E` e o byte extra (`0x00`) que sobrar se tornará um NOP automaticamente quando o x64dbg montar a instrução com a opção "Fill with NOPs".

Navegue até `0x00CCAF8A` e mude a instrução para `jmp 0x0134360E` (com *Fill with NOPs* marcado):

![Adicionando um Code Cave ao Método de Terrain Description do Wesnoth](/assets/images/2/7/wesnoth4.png)

# Esqueleto da Cave

Agora vamos escrever o esqueleto na cave em `0x0134360E`. Por enquanto, o esqueleto apenas salva os registradores, reexecuta as instruções originais que substituímos, e volta:

```c++
pushad
popad
mov eax, dword ptr ds:[ecx]    ; instrução original que substituímos
lea esi, dword ptr ds:[esi]    ; instrução original que substituímos
jmp 0xCCAF90                   ; volta ao próximo ponto no código original
```

![Escrevendo o Esqueleto da Cave no Wesnoth](/assets/images/2/7/wesnoth5.png)

Para verificar que a cave está sendo chamada, coloque um breakpoint em `0x01343610` e retome o jogo. Quando você clicar em *Terrain Description*, o breakpoint deve popar:

![Breakpoint na Code Cave Disparando](/assets/images/2/7/wesnoth6.png)

# Alterar

A verificação funcionou! Agora vamos adicionar nossa modificação de ouro entre o `pushad` e o `popad`. A instrução que moverá o valor 999 (que em hexadecimal é `0x3E7`) para o endereço do ouro:

```c++
mov dword ptr ds:[0x5F3B85C], 0x3E7
```

A cave final fica assim:

![Cave com Modificação de Ouro](/assets/images/2/7/wesnoth7.png)

Agora, quando selecionar *Terrain Description* em qualquer tile do Wesnoth, o ouro vai pular para 999 antes de mostrar a descrição:

![Cave com Modificação de Ouro Funcionando](/assets/images/2/7/wesnoth8.png)

> **Resumo do que aprendemos:** Code caves permitem **adicionar** código sem remover funcionalidade original. O padrão `pushad/popad` protege os registradores. O `jmp` de volta garante que o jogo continua normalmente depois da cave.

&nbsp;