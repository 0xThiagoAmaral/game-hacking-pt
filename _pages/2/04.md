---
title: Alterando o CÃ³digo do Jogo
author: attilathedud
date: 2023-12-25
category: Debugging e ReversÃ£o
layout: post
---

# Alvo

Nosso alvo nesta aula Ã© o **Wesnoth 1.14.9**.

# Identificar

Queremos modificar o Wesnoth para que **recrutar unidades nÃ£o gaste ouro**. Para isso, vamos encontrar e remover a instruÃ§Ã£o do cÃ³digo que desconta o ouro â€” substituindo-a por NOPs.

# Entender

Precisamos de um debugger para visualizar e editar o cÃ³digo do jogo. Vamos usar o **x64dbg**. O processo:

1. Encontrar o endereÃ§o de memÃ³ria do ouro (como na aula anterior)
2. Setar um breakpoint nesse endereÃ§o de memÃ³ria
3. Recrutar uma unidade â†’ o breakpoint dispara â†’ estamos na funÃ§Ã£o certa
4. Substituir a instruÃ§Ã£o de subtraÃ§Ã£o por NOPs

# Localizando o Ouro

Primeiro, abra o Wesnoth e crie um jogo local. Depois, repita os passos da [aula de Memory Hack](/pages/1/05/) com o Cheat Engine para encontrar o endereÃ§o de memÃ³ria do seu ouro.

> **Nota:** O endereÃ§o vai ser diferente de antes! Isso acontece por causa da **AlocaÃ§Ã£o DinÃ¢mica de MemÃ³ria** (DMA) â€” assunto de uma aula futura. Por enquanto, basta refazer a busca toda vez.

Quando encontrar o endereÃ§o, feche o Cheat Engine (mas deixe o Wesnoth aberto). Para este exemplo, usaremos o endereÃ§o `0x051D875C`.

# Anexando o Debugger

Inicie o **x64dbg** â€” especificamente a versÃ£o 32-bit (x32dbg), jÃ¡ que o Wesnoth 1.14.9 Ã© um aplicativo de 32 bits. VocÃª pode encontrÃ¡-lo em:

```
C:\ProgramData\chocolatey\lib\x64dbg.portable\tools\release\x32\x32dbg.exe
```

No menu, clique em *File â†’ Attach*:

![FunÃ§Ã£o Attach do x64dbg](/assets/images/2/4/reversing1.png)

Na janela que abrir, selecione o processo do Wesnoth e clique em *Attach*:

![Selecionando o Wesnoth na Lista de Processos do x64dbg](/assets/images/2/4/reversing2.png)

Ao anexar, o x64dbg vai pausar o jogo e exibir muita informaÃ§Ã£o na tela:

![ExibiÃ§Ã£o Completa do x64dbg com SeÃ§Ãµes Destacadas](/assets/images/2/4/reversing3.png)

Vamos entender as Ã¡reas principais:

| Ãrea | O que mostra |
|---|---|
| **CÃ³digo** (cima, centro) | As instruÃ§Ãµes assembly sendo executadas |
| **Dump** (baixo, centro) | A memÃ³ria em formato hexadecimal e ASCII |
| **Registradores** (direita) | Os valores atuais de cada registrador (eax, ebx, etc.) |
| **Stack** (baixo, direita) | A pilha de chamadas atual |

O debugger estÃ¡ atualmente exibindo o mÃ³dulo `ntdll.dll` â€” uma DLL do sistema carregada em todos os programas Windows. Para ver o cÃ³digo do Wesnoth, vÃ¡ na aba **Symbols** e dÃª duplo-clique em *wesnoth.exe*:

![Aba de SÃ­mbolos e FunÃ§Ã£o do x64dbg](/assets/images/2/4/reversing4.png)

# Configurando o x64dbg

Antes de continuar, vamos desabilitar algumas configuraÃ§Ãµes padrÃ£o do x64dbg que fazem o debugger pausar em momentos desnecessÃ¡rios.

VÃ¡ em *Options â†’ Preferences*:

![OpÃ§Ã£o de PreferÃªncias do x64dbg](/assets/images/2/4/wesnoth2.png)

Na janela que abrir, desmarque a opÃ§Ã£o *TLS Callbacks* e clique em *Save*:

![Desabilitar Breakpoints em TLS Callbacks no x64dbg](/assets/images/2/4/wesnoth3.png)

# Setando o Breakpoint

Agora vamos setar um breakpoint no endereÃ§o de memÃ³ria do ouro. Clique com o botÃ£o direito na Ã¡rea **Dump** e escolha *Go to â†’ Expression*:

![Navegando para um EndereÃ§o no Dump do x64dbg](/assets/images/2/4/reversing5.png)

Na caixa que aparecer, digite o endereÃ§o do ouro (`0x051D875C` no nosso exemplo) e clique *OK*:

![Inserindo o EndereÃ§o do Ouro no x64dbg](/assets/images/2/4/reversing6.png)

O Dump vai mostrar aquele endereÃ§o. Os dados estÃ£o em hexadecimal. No exemplo, o jogador tinha **100 de ouro** â†’ 100 em hexadecimal Ã© `0x64` â€” exatamente o valor exibido:

![Dump do x64dbg Exibindo o EndereÃ§o do Ouro do Jogador](/assets/images/2/4/reversing7.png)

Agora, clique com o botÃ£o direito no valor e escolha *Breakpoint â†’ Hardware, Write â†’ DWORD*. Isso cria um **breakpoint de hardware** que dispara toda vez que aquele endereÃ§o for escrito:

![Setando um Breakpoint de Hardware no EndereÃ§o do Ouro](/assets/images/2/4/reversing8.png)

Com o breakpoint criado, retome a execuÃ§Ã£o clicando no botÃ£o **Play** (triÃ¢ngulo). Pode ser necessÃ¡rio clicar vÃ¡rias vezes, pois o x64dbg tem seus prÃ³prios breakpoints automÃ¡ticos. Continue atÃ© o status *Paused* desaparecer e o jogo voltar a rodar:

![FunÃ§Ã£o de Play/Resume do x64dbg](/assets/images/2/4/reversing9.png)

# Localizando o CÃ³digo

Com o jogo rodando e o breakpoint ativo, volte ao Wesnoth e **recrute uma unidade**. O jogo vai congelar â€” sinal de que o breakpoint disparou. Volte ao x64dbg:

![x64dbg Exibindo a FunÃ§Ã£o Usada para Mudar o Ouro do Jogador](/assets/images/2/4/reversing10.png)

O **EIP** (Extended Instruction Pointer) destaca a posiÃ§Ã£o atual de execuÃ§Ã£o. Ele apontarÃ¡ para a instruÃ§Ã£o imediatamente apÃ³s a que modificou o ouro. Role um pouco para cima na janela de cÃ³digo para ver a instruÃ§Ã£o anterior:

![x64dbg Exibindo a Linha de CÃ³digo Usada para Mudar o Ouro do Jogador](/assets/images/2/4/reversing11.png)

A instruÃ§Ã£o **sub** destacada Ã© a que subtrai o ouro quando vocÃª recruta. Ã‰ exatamente ela que queremos neutralizar.

# Alterar

Para remover a instruÃ§Ã£o `sub`, vamos substituÃ­-la por NOPs. O x64dbg tem uma funÃ§Ã£o automÃ¡tica para isso. Clique com o botÃ£o direito na linha do `sub` e escolha *Binary â†’ Fill with NOPs*:

![Usando a FunÃ§Ã£o Fill do x64dbg para Substituir por NOPs](/assets/images/2/4/reversing12.png)

Clique *OK* na prÃ³xima tela:

![OpÃ§Ãµes da FunÃ§Ã£o Fill do x64dbg](/assets/images/2/4/reversing13.png)

Se tudo correu bem, vocÃª verÃ¡ **trÃªs instruÃ§Ãµes NOP** no lugar da instruÃ§Ã£o `sub`:

![O CÃ³digo Alterado ApÃ³s Substituir o sub por NOPs](/assets/images/2/4/reversing14.png)

> Por que **trÃªs** NOPs? O `sub` original ocupava 3 bytes, e cada NOP ocupa 1 byte. O x64dbg substitui os 3 bytes por 3 NOPs para manter o tamanho do cÃ³digo.

# Finalizando

Antes de testar, precisamos **remover o breakpoint** â€” senÃ£o o jogo vai pausar toda vez que o ouro mudar. VÃ¡ na aba *Breakpoints*, clique com botÃ£o direito no seu breakpoint e escolha *Remove*:

![Aba de Breakpoints do x64dbg](/assets/images/2/4/reversing15.png)

![Removendo um Breakpoint no x64dbg](/assets/images/2/4/reversing16.png)

Agora retome o jogo. Volte ao Wesnoth e recrute algumas unidades â€” seu ouro **nÃ£o vai diminuir mais**! ğŸ‰

&nbsp;