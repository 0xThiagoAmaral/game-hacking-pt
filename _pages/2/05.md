---
title: Revers√£o de C√≥digo
author: attilathedud
date: 2023-12-25
category: Debugging e Revers√£o
layout: post
---

# Alvo

Nosso alvo nesta aula √© o **Wesnoth 1.14.9**.

# Identificar

No Wesnoth, para recrutar unidades voc√™ clica com o bot√£o direito em uma √°rea do mapa e escolhe *Recruit* (Recrutar). Mas aten√ß√£o: o jogo s√≥ permite recrutar em certos tipos de terreno.

Nosso objetivo √© **hackear isso para recrutar em qualquer lugar do mapa**.

![Menus de Contexto do Wesnoth ao Selecionar um Tile](/assets/images/2/5/wesnoth1.png)

# Entender

Este hack precisa de modifica√ß√µes no c√≥digo do jogo. Precisamos encontrar o c√≥digo executado quando o jogador clica com bot√£o direito e escolhe uma op√ß√£o. O c√≥digo original provavelmente tem um formato parecido com:

```c++
switch( option_selected ) {
    case "Terrain Description":
        show_terrain_description(location);
        break;
    case "Recruit":
        recruit_unit(location);
        break;
    // ...
}
```

Um *switch statement* executa diferentes caminhos dependendo de uma vari√°vel. Nosso plano: modificar esse switch para que clicar em *Terrain Description* chame o c√≥digo de recrutamento ‚Äî j√° que *Terrain Description* est√° dispon√≠vel em qualquer tile.

# Subindo na Cadeia de Chamadas (Bubbling)

Na aula anterior, encontramos o c√≥digo respons√°vel por subtrair o ouro ao recrutar. Vamos usar esse c√≥digo como ponto de partida e **"borbulhar para cima"** (*bubble up*) na hierarquia de fun√ß√µes at√© chegar no menu de contexto.

Imagine que a cadeia de chamadas no Wesnoth √© algo assim:

```c++
handle_context_menu()
    recruit_unit()
        find_unit_in_unit_list()
            subtract_unit_cost()
                subtract_gold()
```

N√≥s estamos no `subtract_gold`. Para chegar ao `handle_context_menu`, precisamos subir v√°rios n√≠veis.

**Como borbulhar para cima no debugger?**

Usamos dois bot√µes do x64dbg:
- **Execute till return** ‚Üí executa o c√≥digo at√© o primeiro `retn` (fim da fun√ß√£o atual)
- **Step Over** ‚Üí avan√ßa uma instru√ß√£o sem entrar dentro de fun√ß√µes

Ciclo: `Execute till return` ‚Üí `Step Over` ‚Üí voc√™ subiu um n√≠vel. Repita at√© chegar onde quer.

# Calls e Returns

A instru√ß√£o `call` chama uma fun√ß√£o. No final dela, `retn` retorna para quem chamou. Exemplo:

```c++
main:
    mov eax, 0
    call increase_eax     ; chama a fun√ß√£o
    mov ebx, eax          ; continua depois que a fun√ß√£o retorna

increase_eax:
    add eax, 1
    mov ecx, eax
    retn                  ; retorna para main
```

Diferen√ßa entre **Step Into** e **Step Over** numa instru√ß√£o `call`:
- **Step Into** ‚Üí entra na fun√ß√£o, para na primeira instru√ß√£o dela
- **Step Over** ‚Üí executa a fun√ß√£o inteira e para na pr√≥xima instru√ß√£o **depois** do call

Use Step Over quando n√£o se importa com o que est√° dentro da fun√ß√£o ‚Äî s√≥ quer o resultado.

# Localizando o Menu

Ao contr√°rio de vari√°veis, endere√ßos de c√≥digo geralmente **n√£o mudam** entre sess√µes. Por isso, podemos usar o mesmo endere√ßo da aula anterior (`0x007ccd9e`). Annexe o x64dbg ao Wesnoth, navegue at√© esse endere√ßo e clique na bolinha √† esquerda para setar um breakpoint.

![Setando um Breakpoint no C√≥digo de Subtra√ß√£o de Ouro do Wesnoth](/assets/images/2/5/wesnoth4.png)

V√° ao jogo e recrute uma unidade. O debugger vai pausar no mesmo local de antes:

![x64dbg Exibindo o C√≥digo Chamado ao Recrutar](/assets/images/2/5/wesnoth5.png)

Agora clique em **Execute till return**:

![Fun√ß√£o Execute till return do x64dbg](/assets/images/2/5/wesnoth6.png)

Depois clique em **Step Over** para sair da fun√ß√£o:

![Fun√ß√£o Step Over do x64dbg](/assets/images/2/5/wesnoth7.png)

Voc√™ ser√° levado para o c√≥digo que **chamou** a fun√ß√£o do ouro:

![x64dbg Exibindo o C√≥digo que Chamou o C√≥digo de Recrutamento](/assets/images/2/5/wesnoth8.png)

Continue repetindo esse ciclo. Voc√™ est√° procurando por um padr√£o de m√∫ltiplos `call` com `jmp` entre eles ‚Äî o sinal de um menu de op√ß√µes:

```c++
call some_address
jmp to_end
call some_address
jmp to_end
call some_address
jmp to_end
```

Ap√≥s algumas itera√ß√µes, voc√™ chegar√° neste c√≥digo:

![x64dbg Exibindo o C√≥digo Respons√°vel pelas Opera√ß√µes de Ramifica√ß√£o](/assets/images/2/5/wesnoth9.png)

**Verifica√ß√£o:** NOPeie o `call` que voc√™ acabou de sair. Se recrutar uma unidade no jogo n√£o fizer mais nada, voc√™ encontrou a fun√ß√£o certa! Restaure a instru√ß√£o original depois (bot√£o direito ‚Üí *Restore selection*):

![C√≥digo Ap√≥s NOPear a Opera√ß√£o de Recrutamento](/assets/images/2/5/wesnoth10.png)

![Fun√ß√£o Restore Selection do x64dbg](/assets/images/2/5/wesnoth11.png)

# Localizando Outros Eventos

Com o `call` do evento de recrutar identificado, vamos entender a estrutura. O call tem esta forma:

```c++
call dword ptr ds:[eax+0x54]
```

Ele n√£o chama um endere√ßo fixo ‚Äî chama o endere√ßo que est√° na mem√≥ria em `eax+0x54`. Olhando os demais calls do menu, todos t√™m a mesma forma com um n√∫mero diferente no final:

![x64dbg Exibindo Mais Opera√ß√µes Condicionais do Wesnoth](/assets/images/2/5/wesnoth12.png)

Esses n√∫meros s√£o sempre m√∫ltiplos de 4 ‚Äî um sinal claro de que as fun√ß√µes est√£o num **array de ponteiros**. O c√≥digo original provavelmente √©:

```c++
void* context_menu_functions[MAX_FUNCTIONS] = {
    terrain_description,
    recruit_unit,
    ...
};

context_menu_functions[option_selected]();
```

Sabendo que o recrutar usa offset `0x54`, podemos testar outros valores para descobrir os outros itens do menu. Trocando para `0x28`, aparece a descri√ß√£o de terreno. Trocando para `0x68`... aparece um **menu de debug** para spawnar unidades:

![Menu de Debug do Wesnoth que Permite Spawnar Unidades](/assets/images/2/5/wesnoth14.png)

# Alterar

Nosso hack final: fazer com que o item *Terrain Description* (dispon√≠vel em qualquer tile) chame o menu de debug. Assim, podemos recrutar em qualquer lugar.

Localize o `call` da *Terrain Description* (offset `0x28`):

![O Condicional de Terrain Description](/assets/images/2/5/wesnoth15.png)

Mude o offset de `0x28` para `0x68`:

![Mudando o Condicional de Terrain Description para o Menu de Debug](/assets/images/2/5/wesnoth16.png)

Volte ao Wesnoth, clique com bot√£o direito em qualquer tile e selecione *Terrain Description*. O menu de debug vai aparecer ‚Äî e voc√™ pode spawnar unidades em qualquer lugar! üéâ

![Wesnoth Agora Permite Spawnar Unidades em Qualquer Tile](/assets/images/2/5/wesnoth17.png)

&nbsp;