---
title: Proxy de Tráfego TCP
author: attilathedud
date: 2023-12-25
category: Multiplayer
layout: post
---

# Alvo

Nosso alvo é o **Wesnoth 1.14.9**.

# Visão Geral

Na aula anterior, criamos um cliente externo que replica todo o processo de autenticação do Wesnoth. Uma abordagem mais simples: criar um **proxy** — um intermediário entre o cliente real do jogo e o servidor. O proxy deixa o cliente fazer a autenticação normalmente, e só intercepta o tráfego que nos interessa.

# Por que usar um Proxy?

Quando o cliente externo tenta conectar ao mesmo servidor que o jogo, o servidor trata como **duas conexões completamente separadas**. Cada uma precisa de sua própria autenticação:

![Handshake Falhou](/assets/images/6/5/proxy3.png)

Para interceptar e modificar o tráfego do cliente real, precisamos nos posicionar como **man-in-the-middle (MitM)** — estar entre o jogo e o servidor.

# Como Funciona o Proxy

O proxy age em dois papéis ao mesmo tempo:
- **Para o cliente** → atua como servidor (aceita conexões na porta 27015)
- **Para o servidor** → atua como cliente (conecta no servidor real na porta 15000)

```
JOGO WESNOTH ←→ PROXY ←→ SERVIDOR WESNOTH
   porta 27015      porta 15000
```

O jogo faz toda a autenticação normalmente (o proxy repassa), e nós só modificamos o que queremos no meio do caminho.

O código completo está no [GitHub](https://github.com/GameHackingAcademy/Wesnoth_Proxy/).

# 1. Escutando o Tráfego do Cliente

Baseado no [exemplo de servidor Microsoft:](https://docs.microsoft.com/en-us/windows/win32/winsock/complete-server-code)

```c++
#define DEFAULT_PORT "27015"

SOCKET ListenSocket = INVALID_SOCKET;
SOCKET ClientSocket = INVALID_SOCKET;

// ... setup WinSock ...
hints.ai_flags = AI_PASSIVE;    // socket de escuta
iResult = getaddrinfo(NULL, DEFAULT_PORT, &hints, &result);
ListenSocket = socket(result->ai_family, result->ai_socktype, result->ai_protocol);
bind(ListenSocket, result->ai_addr, (int)result->ai_addrlen);
listen(ListenSocket, SOMAXCONN);
ClientSocket = accept(ListenSocket, NULL, NULL);    // aguarda o jogo conectar
closesocket(ListenSocket);
```

# 2. Conectando ao Servidor Real

```c++
SOCKET ServerSocket = INVALID_SOCKET;

iResult = getaddrinfo("127.0.0.1", "15000", &hints, &result);
ServerSocket = socket(result->ai_family, result->ai_socktype, result->ai_protocol);
connect(ServerSocket, result->ai_addr, (int)result->ai_addrlen);

// Timeout para não bloquear esperando resposta do servidor
DWORD timeout = 1000;
setsockopt(ServerSocket, SOL_SOCKET, SO_RCVTIMEO, (char*)&timeout, sizeof(timeout));
```

> **Por que o timeout?** O Wesnoth não responde a todos os pacotes (ex: chat não tem resposta do servidor). Sem timeout, o proxy ficaria bloqueado esperando uma resposta que nunca vem.

# 3. Relay de Tráfego

O loop principal do proxy:

```c++
do {
    // Espera o cliente enviar algo
    iResult = recv(ClientSocket, (char*)recvbuf, recvbuflen, 0);
    Sleep(100);

    if (iResult > 0) {
        // Verifica se é um \wave (opcional — nossa lógica customizada)
        if (parse_data(recvbuf, iResult)) {
            const unsigned char message[] = "[message]\nmessage=\"Hello!\"\nroom=\"lobby\"\nsender=\"ChatBot\"\n[/message]";
            send_data(message, sizeof(message), ServerSocket);
            Sleep(100);
        }

        // Repassa para o servidor
        send(ServerSocket, (char*)recvbuf, iResult, 0);
        Sleep(100);

        // Espera resposta do servidor (com timeout de 1 segundo)
        iResult = recv(ServerSocket, (char*)recvbuf, recvbuflen, 0);
        Sleep(100);

        // Se chegou resposta, manda para o cliente
        if (iResult != SOCKET_ERROR) {
            send(ClientSocket, (char*)recvbuf, iResult, 0);
            Sleep(100);
        }
    }
} while (iResult > 0 || WSAGetLastError() == WSAETIMEDOUT);
```

# Testando

1. Rode o servidor Wesnoth na porta 15000
2. Rode o proxy (escuta na porta 27015)
3. No Wesnoth, conecte em `localhost:27015`

O jogo faz autenticação normalmente através do proxy, e quando alguém digita `\wave` no chat, o proxy injeta automaticamente uma mensagem `Hello!`:

![Proxy Interceptando Tráfego](/assets/images/6/5/proxy5.png)

**Resultado:** tráfego interceptado e modificado em tempo real, sem precisar reverter o processo de autenticação! ✅

&nbsp;
