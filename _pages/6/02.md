---
title: An√°lise de Pacotes
author: attilathedud
date: 2023-12-25
category: Multiplayer
layout: post
---

# Alvo

Nosso alvo √© o **Wesnoth 1.14.9**.

# Identificar

O Wesnoth tem um modo multiplayer com lobby. Nosso objetivo: analisar os pacotes de conex√£o ao server e criar um cliente que se conecta ao lobby automaticamente.

![Lobby Multiplayer](/assets/images/6/2/bot1.png)

# Entender

Para comunicar em rede, cliente e servidor precisam concordar em:
1. Modelo de rede e protocolo (TCP/UDP)
2. Estrutura dos dados em cada pacote

Como a estrutura √© sempre a mesma, podemos **observar** os pacotes, **reverter** os dados e criar nossos pr√≥prios pacotes com a API WinSock do Windows.

# Servidor Local

No menu *Multiplayer* do Wesnoth, vemos op√ß√µes de conectar a servidores ‚Äî confirmando o modelo client-server. Na pasta do jogo existe `wesnothd.exe` ‚Äî um servidor local que podemos rodar:

![Servidor Wesnoth Rodando](/assets/images/6/2/bot3.png)

Com o servidor rodando, conecte via *Connect to Server* ‚Üí `localhost:15000` (porta padr√£o do Wesnoth). O servidor confirmar√° a conex√£o.

# Observando Pacotes com Wireshark

O Wireshark √© uma ferramenta de captura de pacotes. Instale via:
```powershell
choco install wireshark
```

Selecione a interface de **loopback** (para capturar tr√°fego local). Conecte o Wesnoth ao servidor ‚Äî voc√™ ver√° m√∫ltiplos pacotes:

![Log do Wireshark](/assets/images/6/2/bot7.png)

O protocolo na coluna √© **TCP**. A conex√£o TCP come√ßa com um **three-way handshake** (SYN ‚Üí SYN-ACK ‚Üí ACK). Ap√≥s o handshake, apenas os pacotes com a flag **PSH** cont√™m dados reais. Filtre com `tcp.flags.push == 1`:

![Filtragem por PSH](/assets/images/6/2/bot8.png)

# Estrutura dos Pacotes

Selecionando um pacote, o Wireshark exibe seus segmentos (IP, TCP, dados). Para nossa an√°lise, focamos no componente **Data**.

O fluxo de conex√£o tem 5 pacotes com dados:
1. Cliente ‚Üí Servidor (Pacote 1)
2. Servidor ‚Üí Cliente
3. Cliente ‚Üí Servidor (Pacote 2)
4. Servidor ‚Üí Cliente
5. Cliente ‚Üí Servidor (Pacote 3)

Como estamos criando um **cliente**, s√≥ precisamos reverter os 3 pacotes enviados pelo cliente.

# Criando o Cliente com WinSock

A Microsoft tem um [exemplo completo de cliente WinSock](https://docs.microsoft.com/en-us/windows/win32/winsock/complete-client-code). Usaremos como base.

Modificamos para conectar ao servidor Wesnoth:
```c++
iResult = getaddrinfo("127.0.0.1", "15000", &hints, &result);
```

# Revertendo os Pacotes

Ao testar nosso cliente simples, o servidor responde com erro de handshake. O **primeiro pacote** do cliente cont√©m `00 00 00 00` ‚Äî o in√≠cio do handshake. Adicionamos:

```c++
const unsigned char buff_handshake_p1[] = { 0x00, 0x00, 0x00, 0x00 };
send(ConnectSocket, (const char*)buff_handshake_p1, sizeof(buff_handshake_p1), 0);
recv(ConnectSocket, recvbuf, recvbuflen, 0);
```

O **segundo pacote** cont√©m a vers√£o do cliente comprimida (os dados n√£o mudam entre conex√µes, ent√£o podemos copi√°-los diretamente do Wireshark):

```c++
const unsigned char buff_handshake_p2[] = {
    0x00, 0x00, 0x00, 0x2f, 0x1f, 0x8b, 0x08, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xff, 0x8b, 0x2e, 0x4b, 0x2d, 0x2a, 0xce,
    0xcc, 0xcf, 0x8b, 0xe5, 0xe2, 0x84, 0xb2, 0x6c, 0x95, 0x0c,
    0xf5, 0x0c, 0x4d, 0xf4, 0x2c, 0x95, 0xb8, 0xa2, 0xf5, 0xe1,
    0x92, 0x5c, 0x00, 0xc0, 0x38, 0xd3, 0xd7, 0x28, 0x00, 0x00, 0x00
};
```

O **terceiro pacote** cont√©m o nome do usu√°rio. Enviando o nome *FFFAAAKKKEEE*:
```c++
const unsigned char buff_send_name[] = {
    0x00, 0x00, 0x00, 0x3a, 0x1f, 0x8b, 0x08, 0x00, 0x00, 0x00,
    // ... bytes capturados do Wireshark para o nome FFFAAAKKKEEE
    0x00, 0x00
};
```

Com os tr√™s pacotes enviados corretamente, nosso cliente aparece no lobby do Wesnoth! üéÆ

O c√≥digo completo est√° no [GitHub](https://github.com/GameHackingAcademy/Wesnoth_MultiplayerBot/).

&nbsp;
