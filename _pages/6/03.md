---
title: Revertendo Pacotes
author: attilathedud
date: 2023-12-25
category: Multiplayer
layout: post
---

# Alvo

Nosso alvo √© o **Wesnoth 1.14.9**.

# Identificar

Na aula anterior, identificamos os pacotes de conex√£o e criamos um cliente que os replay. Agora vamos reverter os **pacotes de chat** ‚Äî entender sua estrutura para criar pacotes originais, sem precisar copiar bytes prontos.

# Entender

Para comunicar, cliente e servidor usam uma estrutura de pacote predefinida. Se revertermos essa estrutura, podemos **criar nossos pr√≥prios pacotes** com qualquer conte√∫do.

# Testando Pacotes de Chat

Com o servidor rodando, conecte o Wesnoth e ligue o Wireshark. Envie quatro mensagens:
- `a`
- `a` (repetida ‚Äî para verificar aleatoriedade)
- `aaaaa` (caracteres repetidos ‚Äî para ver padr√µes)
- `hello123` (texto alfanum√©rico ‚Äî para ver se √© leg√≠vel)

**Conclus√µes:**
1. As duas mensagens `a` t√™m bytes **id√™nticos** ‚Üí sem timestamp ou fator de unicidade nos pacotes
2. `aaaaa` exibe um padr√£o `3-3-3-3` nos √∫ltimos bytes ‚Äî esse padr√£o √© do nome `FFFAAAKKKEEE`, n√£o da mensagem ‚Üí o nome est√° no pacote
3. `hello123` n√£o aparece leg√≠vel no pacote ‚Üí **os dados s√£o comprimidos**

Comparando `a` e `b` lado a lado: apenas 2 bytes mudam no meio (o conte√∫do da mensagem) e v√°rios bytes mudam no final (checksum de compress√£o). Os dados **n√£o** s√£o mapeados 1-para-1.

# Identificando a Compress√£o

Cada formato de compress√£o tem uma **assinatura no in√≠cio** (magic bytes). Por exemplo:
- gzip ‚Üí come√ßa com `1F 8B`
- bzip2 ‚Üí come√ßa com `42 5A 68`

Comparando os pacotes: os bytes `1F 8B` aparecem na posi√ß√£o 4 de todos os pacotes. **O Wesnoth usa gzip!**

Para confirmar, usamos o Wireshark para extrair os dados do pacote e tentamos descomprimirlo no terminal:

```powershell
choco install cmder gzip -y

# Extrair dados do pacote (copiado do Wireshark como hex)
echo "1f8b0800..." | xxd -r -p - > file.gz
gzip -d file.gz
```

O arquivo resultante cont√©m dados estruturados e leg√≠veis:

![Dados Descomprimidos](/assets/images/6/3/packet13.png)

```
[message]
  message="a"
  room="lobby"
  sender="FFFAAAKKKEEE"
[/message]
```

# Estrutura do Pacote

O pacote tem dois componentes:

| Bytes | Conte√∫do |
|---|---|
| 0-3 (4 bytes) | Tamanho do dado comprimido (ex: `0x0000004E` = 78 bytes) |
| 4+ | Dados comprimidos em gzip |

# Criando um Pacote Pr√≥prio

Para criar um chat com a mensagem `z`:
1. Modifique o arquivo descomprimido (troque `"a"` por `"z"`)
2. Recomprima com gzip: `gzip file`
3. Limpe o cabe√ßalho gzip para usar os bytes padr√£o do Wesnoth (`00 00 00 00 00 FF`)
4. Calcule o tamanho e adicione os 4 bytes no in√≠cio

```c++
const unsigned char packet_bytes[] = {
    0x00, 0x00, 0x00, 0x4e,    // tamanho (78 bytes)
    0x1f, 0x8b, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff,    // header gzip fixo
    // ... dados comprimidos aqui
    0x00, 0x00, 0x00
};
```

Executando o cliente modificado, a mensagem `z` aparece no chat do lobby ‚Äî provando que criamos um pacote v√°lido do zero! üéØ

&nbsp;