---
title: Criando um Cliente Externo
author: attilathedud
date: 2023-12-25
category: Multiplayer
layout: post
---

# Alvo

Nosso alvo √© o **Wesnoth 1.14.9**.

# Identificar

Vamos criar um **chat bot** ‚Äî um cliente que se conecta ao servidor Wesnoth, aguarda mensagens espec√≠ficas e responde automaticamente.

<video controls autoplay loop>
  <source src="/assets/images/6/4/chat.mp4" />
</video>

# Entender

Na aula anterior, descobrimos que os dados do Wesnoth s√£o comprimidos em **gzip**. A estrutura de envio √©:

1. Comprimir os dados
2. Adicionar o tamanho no in√≠cio (4 bytes)
3. Enviar via socket

E para receber:
1. Separar o tamanho (bytes 0-3) dos dados (bytes 4+)
2. Descomprimir os dados
3. Analisar o conte√∫do

# Instalando ZLib

Para comprimir/descomprimir gzip em C++, usamos a biblioteca **ZLib**. Instale o *Complete package* do [site GnuWin32](http://gnuwin32.sourceforge.net/packages/zlib.htm).

No Visual Studio, configure o projeto:

1. **C/C++ ‚Üí Additional Include Directories** ‚Üí `C:\Program Files (x86)\GnuWin32\include`
2. **Linker ‚Üí Additional Library Directories** ‚Üí `C:\Program Files (x86)\GnuWin32\lib`
3. **Linker ‚Üí Input ‚Üí Additional Dependencies** ‚Üí adicione `zlib.lib`

Corrija o erro de `unistd.h` na ZLib: mude `#if 1` para `#if HAVE_UNISTD_H`. Copie `zlib1.dll` para o diret√≥rio do execut√°vel.

# Fun√ß√£o de Envio

```c++
#include <zlib.h>

void send_data(const unsigned char *data, size_t len, SOCKET s) {
    // 1. Comprimir os dados para um arquivo .gz tempor√°rio
    gzFile temp_data = gzopen("packet.gz", "wb");
    gzwrite(temp_data, data, len);
    gzclose(temp_data);

    // 2. Ler o arquivo comprimido como bytes
    FILE* temp_file = NULL;
    fopen_s(&temp_file, "packet.gz", "rb");
    size_t compress_len = 0;
    unsigned char buffer[DEFAULT_BUFLEN] = { 0 };
    compress_len = fread(buffer, 1, sizeof(buffer), temp_file);
    fclose(temp_file);

    // 3. Montar o pacote: 4 bytes de tamanho + dados comprimidos
    unsigned char buff_packet[DEFAULT_BUFLEN] = { 0 };
    memcpy(buff_packet + 3, &compress_len, sizeof(compress_len));    // tamanho no byte 3
    memcpy(buff_packet + 4, buffer, compress_len);                   // dados a partir do byte 4

    // 4. Enviar
    send(s, (const char*)buff_packet, compress_len + 4, 0);
}
```

Exemplo de uso para enviar a vers√£o:
```c++
const unsigned char version[] = "[version]\nversion=\"1.14.9\"\n[/version]";
send_data(version, sizeof(version), ConnectSocket);
```

# Conectando com Nome Personalizado

```c++
const unsigned char name[] = "[login]\nusername=\"ChatBot\"\n[/login]";
send_data(name, sizeof(name), ConnectSocket);

const unsigned char first_message[] = "[message]\nmessage=\"ChatBot conectado!\"\nroom=\"lobby\"\nsender=\"ChatBot\"\n[/message]";
send_data(first_message, sizeof(first_message), ConnectSocket);
```

# Fun√ß√£o de Recep√ß√£o e Parse

```c++
bool parse_data(unsigned char *buff, int buff_len) {
    // 1. Extrair dados comprimidos (a partir do byte 4)
    unsigned char data[DEFAULT_BUFLEN] = { 0 };
    memcpy(data, buff + 4, buff_len - 4);

    // 2. Salvar como arquivo .gz
    FILE* temp_file = NULL;
    fopen_s(&temp_file, "packet_recv.gz", "wb");
    fwrite(data, 1, sizeof(data), temp_file);
    fclose(temp_file);

    // 3. Descomprimir e ler
    gzFile temp_data_in = gzopen("packet_recv.gz", "rb");
    unsigned char decompressed_data[DEFAULT_BUFLEN] = { 0 };
    gzread(temp_data_in, decompressed_data, DEFAULT_BUFLEN);
    gzclose(temp_data_in);

    // 4. Retornar true se o texto "\wave" estiver contido
    return strstr((const char*)decompressed_data, (const char*)"\\wave");
}
```

# Bot Principal

```c++
do {
    iResult = recv(ConnectSocket, (char*)recvbuf, recvbuflen, 0);
    if (iResult > 0) {
        if (parse_data(recvbuf, iResult)) {
            const unsigned char message[] = "[message]\nmessage=\"Hello!\"\nroom=\"lobby\"\nsender=\"ChatBot\"\n[/message]";
            send_data(message, sizeof(message), ConnectSocket);
        }
    }
} while (iResult > 0);
```

O bot se conecta ao lobby, anuncia a conex√£o e responde `Hello!` sempre que algu√©m digitar `\wave` no chat. Bot multiplayer funcional! ü§ñ

O c√≥digo completo est√° no [GitHub](https://github.com/GameHackingAcademy/Wesnoth_ChatBot).

&nbsp;
