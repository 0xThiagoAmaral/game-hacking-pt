---
title: Chams (OpenGL)
author: attilathedud
date: 2023-12-25
category: FPS
layout: post
---

# Alvo

Nosso alvo é o **Urban Terror 4.3.4**.

# Identificar

Vamos criar um **chams** — um hack que pinta os modelos de jogadores com uma cor sólida e brilhante (como vermelho), facilitando identificá-los mesmo através das paredes.

# Entender

Quando entidades são renderizadas, elas são polígonos preenchidos. Para parecerem reais (olhos, camuflagem, cabelo), **texturas** são aplicadas — imagens 2D envolvidas ao redor do modelo 3D.

Por exemplo, a textura do barril de petróleo do Urban Terror:

![Textura do Urban Terror](/assets/images/5/4/urbanterror1.png)

Para criar o chams, interferimos no fluxo de renderização:
1. Após os polígonos serem desenhados, **desabilitamos as texturas** no OpenGL
2. Com as texturas desabilitadas, o OpenGL recorre ao **color array** definido pelo jogo
3. Se desabilitarmos também o color array, o OpenGL usa a **última cor definida por `glColor`**
4. Definimos nossa própria cor antes de renderizar → a entidade aparece em cor sólida

# Ponteiros de Função para Texturas

Construindo sobre o wallhack da aula anterior, criamos ponteiros de função para quatro funções adicionais do OpenGL:

```c++
void(__stdcall* glColor4f)(float, float, float, float) = NULL;  // define a cor
void(__stdcall* glEnable)(unsigned int) = NULL;                 // ativa feature
void(__stdcall* glDisable)(unsigned int) = NULL;                // desativa feature
void(__stdcall* glEnableClientState)(unsigned int) = NULL;      // ativa estado
void(__stdcall* glDisableClientState)(unsigned int) = NULL;     // desativa estado
```

Assignando via `GetProcAddress` (igual aos ponteiros anteriores):

```c++
glColor4f = (void(__stdcall*)(float, float, float, float))GetProcAddress(openGLHandle, "glColor4f");
glEnable = (void(__stdcall*)(unsigned int))GetProcAddress(openGLHandle, "glEnable");
glDisable = (void(__stdcall*)(unsigned int))GetProcAddress(openGLHandle, "glDisable");
glEnableClientState = (void(__stdcall*)(unsigned int))GetProcAddress(openGLHandle, "glEnableClientState");
glDisableClientState = (void(__stdcall*)(unsigned int))GetProcAddress(openGLHandle, "glDisableClientState");
```

# Code Cave — Aplicando a Cor

Expandindo a code cave do wallhack. Para entidades com `count > 500` (jogadores/armas):

**1. Desabilitar texturas e color array:**
```c++
(*glDisableClientState)(0x8078);    // GL_COLOR_ARRAY — desativa array de cores
(*glDisableClientState)(0x8076);    // GL_TEXTURE_COORD_ARRAY — desativa texturas
```

**2. Habilitar color material e definir a cor:**
```c++
(*glEnable)(0x0B57);                     // GL_COLOR_MATERIAL — usa cor sólida
(*glColor4f)(1.0f, 0.6f, 0.6f, 1.0f);   // R=1, G=0.6, B=0.6, A=1 → vermelho vibrante
```

> **Por que não usar `(1, 0, 0, 1)`?** Um vermelho puro sem verde ou azul fica escuro e pouco visível. Adicionar 0.6 de G e B cria um vermelho mais saturado e brilhante.

**3. Restaurar para entidades normais (count ≤ 500):**
```c++
(*glEnableClientState)(0x8078);          // restaura GL_COLOR_ARRAY
(*glEnableClientState)(0x8076);          // restaura GL_TEXTURE_COORD_ARRAY
(*glDisable)(0x0B57);                    // restaura mapeamento de texturas
(*glColor4f)(1.0f, 1.0f, 1.0f, 1.0f);  // branco = sem tint de cor
```

> Restaurar para branco não é estritamente necessário no Urban Terror, mas em alguns jogos, manter a cor vermelha corromperia os efeitos visuais subsequentes (sangue, explosões) que usam a cor anterior.

# Resultado

Injete a DLL e os modelos de jogadores aparecerão em vermelho brilhante através das paredes:

![Chams](/assets/images/5/4/urbanterror2.png)

O código completo está no [GitHub](https://github.com/GameHackingAcademy/UrbanTerror_OpenGLChams/).

&nbsp;
