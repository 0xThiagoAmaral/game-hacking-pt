---
title: Triggerbot
author: attilathedud
date: 2023-12-25
category: FPS
layout: post
---

# Alvo

Nosso alvo é o [Assault Cube 1.2.0.2](https://assault.cubers.net/) — um FPS que tem um modo de bots fácil de configurar.

# Identificar

Vamos criar um **triggerbot** — um hack que **dispara automaticamente** quando estamos mirando em outro jogador. A mesma técnica funciona em qualquer FPS que exibe o nome do jogador ao passar o cursor sobre ele.

# Injeção de DLL

A partir desta aula, recomendamos usar um **DLL Injector** ao invés do AppInit_DLLs. O injector é muito mais rápido para o ciclo de desenvolvimento (compilar → injetar → testar). A criação de um DLL Injector é abordada na [lição DLL Injector](/pages/7/01/).

# Entender

Para disparar quando estamos mirando num jogador, o jogo já calcula isso internamente — para exibir a **nametag** (nome do jogador) no HUD. Vamos hookear a função responsável por essa lógica e enviar um clique do mouse quando ela detectar um jogador.

O Assault Cube exibe a nametag no canto inferior esquerdo ao mirar:

![Nametag do Assault Cube](/assets/images/5/5/cube1.png)

# Localizando o Código

**Método 1 — A mira muda de cor/tamanho:**
- Busca por *Unknown value* no Cheat Engine enquanto não mira num jogador
- Ao mirar num jogador, filtre por *Changed value*
- Repita até sobrar um valor (geralmente 0 = não mirando, 1 = mirando)
- Sete breakpoint de escrita e encontre o código

**Método 2 — O nome do jogador aparece (Assault Cube):**
- Busque o nome de um bot no Cheat Engine
- Use *Find out what accesses this address* para cada endereço encontrado
- Identifique qual é acessado continuamente apenas ao mirar no bot

Configure um jogo deathmatch com 8 bots. Abra o console (`~`) e rode `idlebots 1` para imobilizar os bots (facilita a pesquisa):

![Speedhack do Cheat Engine para Câmera Lenta](/assets/images/5/5/cube2.png)

Busque o nome de um bot no Cheat Engine (~10 resultados). Mire no bot e use *Find out what accesses this address* para cada endereço:

![Buscando Nomes de Jogadores](/assets/images/5/5/cube3.png)

O endereço correto terá muitos acessos apenas quando você estiver mirando:

![Código das Nametags](/assets/images/5/5/cube5.png)

# Localizando a Code Cave

Anexe o x64dbg ao Assault Cube e navegue até o endereço encontrado. Sete um breakpoint — ele dispara apenas quando mira num bot:

![Código das Nametags](/assets/images/5/5/cube6.png)

A lógica é: o `test edi, edi` verifica se **edi** é 0. Se for 0, o `je` pula o código de exibição da nametag (não está mirando num jogador). **edi** recebe seu valor de **eax**, retornado pelo `call` acima:

![Código das Nametags](/assets/images/5/5/cube9.png)

Como o `call` tem 5 bytes, podemos substituí-lo por um jmp para nossa cave.

# Escrevendo a Code Cave

A lógica da cave:
1. Executa o `call` original
2. Lê **eax** (retorno = endereço do jogador mira ou 0)
3. Se não for 0, envia `MOUSEEVENTF_LEFTDOWN` (atirar)
4. Se for 0, envia `MOUSEEVENTF_LEFTUP` (soltar o botão)

> **Por que enviar LEFTUP?** `SendInput` define o estado do botão permanentemente. Sem enviar LEFTUP quando paramos de mirar, o mouse ficaria "travado" pressionado para sempre.

```c++
DWORD ori_call_address = 0x4607C0;
DWORD ori_jump_address = 0x0040ADA2;
DWORD edi_value = 0;

__declspec(naked) void codecave() {
    __asm {
        call ori_call_address       // executa a função original
        pushad
        mov edi_value, eax          // salva o retorno
    }

    INPUT input = { 0 };
    input.type = INPUT_MOUSE;
    if (edi_value != 0) {
        // Mirando em um jogador — atira
        input.mi.dwFlags = MOUSEEVENTF_LEFTDOWN;
    } else {
        // Não está mirando — solta o botão
        input.mi.dwFlags = MOUSEEVENTF_LEFTUP;
    }
    SendInput(1, &input, sizeof(INPUT));

    __asm {
        popad
        jmp ori_jump_address
    }
}
```

Redirecionamento no `DllMain`:

```c++
unsigned char* hook_location = (unsigned char*)0x0040AD9D;
VirtualProtect((void*)hook_location, 5, PAGE_EXECUTE_READWRITE, &old_protect);
*hook_location = 0xE9;
*(DWORD*)(hook_location + 1) = (DWORD)&codecave - ((DWORD)hook_location + 5);
```

Injete a DLL no Assault Cube e mire em um bot — você vai disparar automaticamente ao passar o cursor sobre qualquer jogador:

<video controls autoplay loop>
  <source src="/assets/images/5/5/cube.mp4" />
</video>

O código completo está no [GitHub](https://github.com/GameHackingAcademy/AssaultCube_Triggerbot/).

&nbsp;
