---
title: Farming Bot
author: attilathedud
date: 2023-12-25
category: RTS
layout: post
---

> *Nota: Os ponteiros fornecidos nesta aula podem estar incorretos. Voc√™ precisar√° ajust√°-los com os que encontrar ao seguir o tutorial.*

# Alvo

Nosso alvo nesta aula √© o [Flare 1.12](https://flarerpg.org/), um ARPG (Action RPG) similar ao Diablo. Como nossos outros alvos, √© gratuito, open source e sem anti-cheat.

# Identificar

Em ARPGs como o Flare, a maior parte do tempo √© gasta matando inimigos para ganhar ouro e experi√™ncia. Nosso goal √© criar um **farming bot** ‚Äî um bot que automaticamente localiza inimigos na tela e move nosso personagem para atac√°-los.

<video controls autoplay loop>
  <source src="/assets/images/4/4/flare.mp4" />
</video>

# Entender

Para o farming bot, precisamos de tr√™s valores na mem√≥ria:
1. **Posi√ß√£o do jogador** (X e Y)
2. **Posi√ß√£o do inimigo** (X e Y)
3. **Posi√ß√£o do cursor do mouse** (X e Y)

Com isso, calculamos a dire√ß√£o do jogador at√© o inimigo, posicionamos o cursor na dire√ß√£o correta e enviamos um evento de clique. Um loop faz isso continuamente enquanto o bot estiver ativo.

# Localizando a Posi√ß√£o do Jogador

Posi√ß√µes geralmente s√£o armazenadas como **floats** (n√∫meros decimais). No Cheat Engine, fa√ßa uma varredura de *Unknown value* do tipo *Float*.

Ap√≥s a varredura inicial:
- Mova o personagem para baixo ‚Üí filtre por *Increased value*
- Mova o personagem para cima ‚Üí filtre por *Decreased value*
- Repita at√© ter ~150 resultados

Para identificar o endere√ßo correto, selecione metade dos resultados e mude seus valores. Se o personagem teletransportou na tela, o endere√ßo verdadeiro est√° no grupo que voc√™ modificou. Divida e repita at√© sobrar apenas um. No exemplo: `0x0AE6931C`.

Use *Find out what writes to this address* no Cheat Engine para encontrar o c√≥digo que modifica a posi√ß√£o:

![Buscando Posi√ß√£o do Jogador](/assets/images/4/4/flare2.png)

Um √∫nico endere√ßo deve aparecer. Abra o x64dbg e navegue at√© ele:

![Buscando Posi√ß√£o do Jogador](/assets/images/4/4/flare4.png)

N√∫meros de ponto flutuante usam instru√ß√µes especiais. A mais relevante aqui √© **fstp** ‚Äî que funciona como um `mov` mas para floats, copiando o valor do registrador especial `st0` para a mem√≥ria.

Sete um breakpoint na instru√ß√£o `fstp dword ptr ss:[ebp],st(0)` e mova o personagem. Quando disparar, siga **ebx** no dump:

![Buscando Posi√ß√£o do Jogador](/assets/images/4/4/flare5.png)

Para ver os valores como floats (em vez de DWORD hex), clique com bot√£o direito ‚Üí *Float ‚Üí Float (32-bit)*:

![Buscando Posi√ß√£o do Jogador](/assets/images/4/4/flare7.png)

**ebp** e **ebx** cont√™m as posi√ß√µes X e Y do jogador.

# Sistema de Coordenadas do Flare

O Flare usa perspectiva **isom√©trica** ‚Äî os eixos X e Y s√£o rotacionados 45 graus. Mover para cima/baixo no jogo altera **ambos** os valores X e Y ao mesmo tempo:

![Sistema de Coordenadas do Flare](/assets/images/4/4/flare8.png)

# Localizando a Posi√ß√£o dos Inimigos

Jogos reutilizam o mesmo c√≥digo de f√≠sica/movimento para jogadores e inimigos. O mesmo `fstp` que atualiza o jogador provavelmente √© chamado para inimigos tamb√©m.

Sete o breakpoint novamente e mova o personagem para uma tela **sem** inimigos ‚Äî o breakpoint s√≥ disparou para o jogador. Depois, v√° para uma tela **com** inimigos e pare de mover. Se o breakpoint disparar quando voc√™ n√£o est√° se movendo, √© para um inimigo!

Suba um n√≠vel: o endere√ßo do c√≥digo chamador ser√° diferente para jogador e inimigo. Guardaremos essas duas refer√™ncias para identificar em qual entidade estamos quando a cave for executada.

# Localizando a Posi√ß√£o do Mouse

O Windows tem a API [SetCursorPos](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setcursorpos) para mover o cursor ‚Äî ela usa dois `int`s (X e Y). No Cheat Engine, procure por *4 Bytes Unknown value*.

- Mova o cursor para a direita ‚Üí *Increased value*
- Mova para a esquerda ‚Üí *Decreased value*
- Repita at√© sobrar poucos endere√ßos

Sete um breakpoint de escrita no endere√ßo correto. Voc√™ chegar√° numa fun√ß√£o onde `ebp+0x644` = X do mouse e `ebp+0x648` = Y do mouse.

# Criando a DLL

Nossa DLL ter√° **3 code caves** mais uma **thread principal**:

| Cave | Fun√ß√£o |
|---|---|
| `mouse_codecave` | Captura ponteiros para X e Y do mouse |
| `player_codecave` | Captura ponteiros para X e Y do jogador |
| `loop_codecave` | Captura ponteiros para X e Y do inimigo |

**Cave do mouse:**
```c++
DWORD* mouse_x = NULL;
DWORD* mouse_y = NULL;

__declspec(naked) void mouse_codecave() {
    __asm {
        call mouse_call_address
        pushad
        mov eax, ebp
        add eax, 0x664
        mov ebx, ebp
        add ebx, 0x668
        mov mouse_x, eax
        mov mouse_y, ebx
        popad
        jmp mouse_return_address
    }
}
```

**Cave do loop (posi√ß√£o do inimigo):**
```c++
float* enemy_x = NULL;
float* enemy_y = NULL;

__declspec(naked) void loop_codecave() {
    __asm {
        pushad
        mov eax, ebx
        sub eax, 4
        mov enemy_x, eax   // X est√° em ebx-4
        mov enemy_y, ebx   // Y est√° em ebx
        popad
        call loop_call_address
        jmp loop_return_address
    }
}
```

**Thread principal do bot:**
```c++
void injected_thread() {
    while (true) {
        // Verifica se todos os ponteiros foram capturados e a tecla M est√° pressionada
        if (player_x && enemy_x && mouse_x && player_x != enemy_x && GetAsyncKeyState('M')) {

            // Move o cursor na dire√ß√£o do inimigo (quatro dire√ß√µes isom√©tricas)
            if (*enemy_x < *player_x) *mouse_x = 490;
            else *mouse_x = 560;

            if (*enemy_y > *player_y) *mouse_y = 270;
            else *mouse_y = 330;

            // Envia um clique do mouse
            INPUT input = { 0 };
            input.type = INPUT_MOUSE;
            input.mi.dwFlags = MOUSEEVENTF_LEFTDOWN;
            SendInput(1, &input, sizeof(INPUT));
        }

        Sleep(1);
    }
}
```

Compile, injete e abra uma tela com inimigos. Segure **M** ‚Äî o personagem vai perseguir e atacar os inimigos automaticamente! üéÆ

O c√≥digo completo est√° no [GitHub](https://github.com/GameHackingAcademy/Flare_FarmingBot).

&nbsp;
