---
title: Map Hack
author: attilathedud
date: 2023-12-25
category: RTS
layout: post
---

> *Nota: Não consigo mais reproduzir de forma consistente o método para identificar o valor 4294967295. O tutorial será atualizado no futuro com um método mais confiável.*

# Alvo

Nosso alvo nesta aula é o **Wesnoth 1.14.9**.

# Identificar

Vamos criar um **map hack** — um hack que revela o mapa inteiro para o jogador e remove a névoa de guerra.

# Entender

Em jogos de estratégia como o Wesnoth, cada tile do mapa pode estar visível ou coberto pela névoa de guerra (*fog-of-war*):

![Névoa de Guerra no Wesnoth](/assets/images/4/2/wesnoth1.png)

O jogo precisa guardar em algum lugar da memória quais tiles são visíveis. Uma forma comum de representar isso é com um array:

```c++
int map[map_size] = {0, 0, 1, 0, 0, 1, 1, 1, 0, ...}
```

Cada vez que o jogador move uma unidade, o jogo:
1. Define todos os tiles como invisíveis
2. Percorre cada unidade do jogador e marca os tiles ao redor como visíveis

Para encontrar esses dados no Wesnoth, usaremos o seguinte processo:
1. Varredura desconhecida no Cheat Engine
2. Mova uma unidade para revelar tiles → filtre por *Valor Alterado*
3. Mova a unidade de volta → filtre novamente
4. Repita até restar ~50 resultados
5. Teste os endereços manualmente para identificar quais controlam a visibilidade dos tiles

# Localizando os Dados do Mapa

Crie um jogo local com um oponente. Inicie um **New Scan** de *Unknown value* no Cheat Engine. Mova uma unidade para revelar novos tiles, depois filtre por *Changed value*. Mova a unidade de volta e filtre novamente. Repita até ter cerca de 10 endereços:

![Conjunto de Resultados da Busca de Tiles](/assets/images/4/2/wesnoth2.png)

Para confirmar que esses são os endereços corretos, ative o checkbox de cada endereço na coluna *Active* (que bloqueia modificações ao valor). Mova sua unidade — os tiles cobertos pela névoa **não deveriam mais aparecer como cobertos**. Isso confirma que encontramos os dados de mapa corretos.

# Localizando o Código do Mapa

Observando o Cheat Engine, quando um tile está **oculto** o valor é grande e variado; quando **visível**, o valor é sempre `4294967295`:

![Conjunto de Resultados da Busca de Tiles](/assets/images/4/2/wesnoth3.png)

Tente definir outro endereço identificado para esse valor. Uma coluna inteira de tiles deve ficar visível:

![Tiles do Mapa Revelados](/assets/images/4/2/wesnoth4.png)

Scrollando o mapa para cima, vemos que uma coluna inteira do topo ao fundo é controlada por um único endereço:

![Tiles do Mapa Revelados](/assets/images/4/2/wesnoth5.png)

Revisando nosso modelo: o Wesnoth usa um **array de colunas** de tiles, não de tiles individuais. Cada coluna é um valor entre 0 e `4294967295 (= 0xFFFFFFFF)`, representando quantos tiles daquela coluna estão visíveis.

Agora, annexe o x64dbg e sete um breakpoint de escrita num dos endereços de coluna. Mova uma unidade para revelar aquele tile — o breakpoint deve disparar:

![Breakpoint Responsável pela Escrita nos Tiles](/assets/images/4/2/wesnoth6.png)

O registrador **esi** contém os dados da coluna. Scrollando para cima, você vê o código responsável por definir esse valor:

![Código Responsável pela Escrita nos Tiles](/assets/images/4/2/wesnoth7.png)

# Modificando o Código do Mapa

Para revelar sempre todos os tiles, precisamos que o valor de cada coluna seja sempre `0xFFFFFFFF`. Usaremos uma instrução **or**:

> **Por que `or` em vez de `mov`?** O `mov dword ptr, 0xFFFFFFFF` ocuparia 6 bytes — mais do que o espaço disponível. A instrução `or [esi], 0xFF` ocupa apenas 3 bytes. O resultado é o mesmo: qualquer bit `OR 1 = 1`, então `OR 0xFF...FF` sempre produz `0xFFFFFFFF`.

Substitua as instruções relevantes por `or dword ptr ds:[esi], 0xFFFFFFFF` (e NOPs para preencher o espaço restante):

![Definindo Tiles para 0xFFFFFFFF](/assets/images/4/2/wesnoth8.png)

Com essa mudança, o mapa inteiro fica visível:

![Map-hack Exibindo o Mapa Completo](/assets/images/4/2/wesnoth9.png)

# Criando a DLL

Para tornar o hack persistente, registramos os opcodes gerados pelo x64dbg e os escrevemos via DLL:

```c++
// Esses bytes foram copiados do x64dbg após a modificação
unsigned char new_bytes[8] = { 0x90, 0x90, 0x90, 0x83, 0x0E, 0xFF, 0x90, 0x90 };

unsigned char* hook_location = (unsigned char*)0x6CD519;

if (fdwReason == DLL_PROCESS_ATTACH) {
    VirtualProtect((void*)hook_location, 8, PAGE_EXECUTE_READWRITE, &old_protect);
    for (int i = 0; i < sizeof(new_bytes); i++) {
        *(hook_location + i) = new_bytes[i];
    }
}
```

Injete a DLL como nas aulas anteriores. Com ela ativa, o mapa inteiro ficará revelado em qualquer mapa do jogo.

O código completo está no [GitHub](https://github.com/GameHackingAcademy/Wesnoth_Maphack/).

&nbsp;
